name: Deploy to Shared Hosting

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ⏬ Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      # === BACKEND ===
      - name: 📦 Install backend dependencies
        run: npm install

      - name: 🛠 Build backend
        run: npm run build

      - name: 🗄 Run backend migrations
        run: npm run migration:run # Adjust based on your command

      # === FRONTEND ===
      - name: 📦 Install frontend dependencies
        run: npm install
        working-directory: ./frontend

      - name: 🛠 Build frontend (Vite)
        run: npm run build
        working-directory: ./frontend

      # === DEPLOY (Manual/FTP) ===
      - name: 📂 Upload to CPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4

        with:
          server: ftp.abyinventory.com
          username: deploy@abyinventory.com
          password: Abyinvetory12@
          local-dir: ./frontend/dist
          server-dir: /public_html/

      - name: 📂 Upload backend to CPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4

        with:
          server: ftp.abyinventory.com
          username: deploy@abyinventory.com
          password: Abyinvetory12@
          local-dir: ./backend/dist
          server-dir: /backend/
